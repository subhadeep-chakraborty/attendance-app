<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Grades - Class Monitor App</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<header>
    <h1>Class Monitor App</h1>
    <nav aria-label="Teacher navigation">
        <a th:href="@{/teacher}">Dashboard</a> |
        <a th:href="@{/mark-attendance}">Mark Attendance</a> |
        <a th:href="@{/record-grades}">Record Grades</a> |
        <a th:href="@{/logout}">Logout</a>
    </nav>
</header>

<main>
    <h2>Record Grades</h2>

    <form id="gradeForm" th:action="@{/record-grades}" method="post">
        <label for="class">Class:</label>
        <select id="class" name="subjectId" required>
            <option value="" disabled selected>Select Class</option>
            <option th:each="sub : ${subjects}" th:value="${sub.id}" th:text="${sub.name}">Class</option>
        </select>

        <div id="studentTableContainer" style="margin-top: 20px; display:none;">
            <table border="1" id="students-table">
                <thead>
                <tr>
                    <th>Student</th>
                    <th>Grade</th>
                    <th>Feedback</th>
                </tr>
                </thead>
                <tbody>
                <!-- filled by JS -->
                </tbody>
            </table>
            <button type="submit" style="margin-top:10px;">Save Grades</button>
        </div>
    </form>
</main>

<script>
    $('#class').change(function () {
        const subjectId = $(this).val();

        if (!subjectId) {
            $('#studentTableContainer').hide();
            return;
        }

        $.get('/get-students', { subjectId: subjectId }, function (students) {
            if (!students || students.length === 0) {
                $('#students-table tbody').html('<tr><td colspan="3">No students enrolled.</td></tr>');
            } else {
                let rows = '';
                students.forEach(student => {
                    rows += `
                        <tr>
                            <td>${student.name} (${student.email})</td>
                            <td><input type="text" name="grades[${student.email}].grade" placeholder="A-F" required></td>
                            <td><textarea name="grades[${student.email}].feedback" rows="2" cols="20"></textarea></td>
                        </tr>`;
                });
                $('#students-table tbody').html(rows);
            }
            $('#studentTableContainer').show();
        }).fail(function () {
            alert("Failed to fetch students. Please try again.");
            $('#studentTableContainer').hide();
        });
    });
</script>
</body>
</html>
